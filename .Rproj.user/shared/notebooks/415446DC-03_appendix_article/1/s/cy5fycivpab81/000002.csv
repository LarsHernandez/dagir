"0","data <- mss %>% "
"0","  group_by(IDNr) %>% "
"0","  mutate(age = round(as.numeric(difftime(min(date), first(date_birth)))/365.24)) %>%"
"0","  mutate(firstpdate = min(date)) %>% "
"0","  ungroup() %>% "
"0","  mutate(Diag      = grp,"
"0","         ncom      = if_else(is.na(score), 0, score), #some patients have no diagnoses before first treatment, this returns NA, which should be 0"
"0","         Cdiag     = if_else(is.na(cdiag), ""unknown"", cdiag),"
"0","         Gender    = if_else(gender == ""M"", ""Male"", ""Female""),"
"0","         Age       = case_when(age <  45                  ~ ""18-44"","
"0","                               age >= 45 & age < 65       ~ ""45-64"","
"0","                               age >= 65 & age < 75       ~ ""65-74"","
"0","                               age >= 75 & age < 130      ~ ""75+""), "
"0","         BMI       = case_when(bmi <  18.5                ~ ""Underweight"","
"0","                               bmi >= 18.5 & bmi < 25     ~ ""Normal"","
"0","                               bmi >= 25 & bmi < 30       ~ ""Overweight"","
"0","                               bmi >= 30                  ~ ""Obese""),"
"0","         Diagnoses      = factor(if_else(ndiag_pre < 3, as.character(ndiag_pre), ""3+"")),"
"0","         Comorbiditiesc = factor(paste0(""c"",if_else(ncom < 2, as.character(ncom), ""2+""))),"
"0","         Comorbidities  = factor(if_else(ncom < 2, as.character(ncom), ""2+"")),"
"0","         Diagnoses      = fct_relevel(Diagnoses, ""1"",""2"",""3+""),"
"0","         Comorbiditiesc = fct_relevel(Comorbiditiesc, ""c0"",""c1"",""c2+""),"
"0","         BMI            = fct_relevel(BMI, ""Normal"",""Underweight"",""Overweight""),"
"0","         Age            = fct_relevel(Age, ""45-64"",""18-44"",""65-74"",""75+""),  "
"0","         Diag           = fct_relevel(Diag, ""Lung"",""Breast"",""Colon"",""Rectum"",""Pancreas"",""Prostate"",""Stomach"",""Ovary"",""Brain"",""Others""),"
"0","         Year           = as.factor(year(firstpdate)),"
"0","         Period = case_when(Year %in% 2008:2011 ~ ""2008-2011"","
"0","                            Year %in% 2012:2015 ~ ""2012-2015"","
"0","                            Year %in% 2016:2019 ~ ""2016-2019""))"
"0",""
"0","data_all_1 <- data %>% group_by(IDNr) %>% filter(!is.na(Age))"
"0","data_all_2 <- data_all_1 %>% filter(firstpdate > as.Date(""2008-04-01""))"
"0","data_all_3 <- data_all_2 %>% filter(firstpdate < as.Date(""2017-01-01""))"
"0","data_all_4 <- data_all_3 %>% ungroup() %>% filter(date <= add_with_rollback(firstpdate, years(3), roll_to_first = TRUE))"
"0",""
"0","data_bmi_1 <- data %>% group_by(IDNr) %>% filter(!is.na(Age),!is.na(BMI))"
"0","data_bmi_2 <- data_bmi_1 %>% filter(firstpdate > as.Date(""2008-04-01""))"
"0","data_bmi_3 <- data_bmi_2 %>% filter(firstpdate < as.Date(""2017-01-01""))"
"0","data_bmi_4 <- data_bmi_3 %>% ungroup() %>% filter(date <= add_with_rollback(firstpdate, years(3), roll_to_first = TRUE))"
"0",""
"0","set.seed(13022021)"
"0","resm <- data_all_4 %>% "
"0","  group_by(IDNr) %>% "
"0","  summarize(across(c(Diag, Diagnoses, Comorbidities, Comorbiditiesc, Gender, Age, BMI, ncom, bmi, Year, Period,"
"0","                     all_of(com_short)), first),"
"0","            med_price_eur = sum(med_price_eur, na.rm = T)) %>% "
"0","  mutate(cost = if_else(med_price_eur >= sort(.$med_price_eur,decreasing = T)[round((length(unique(.$IDNr))/100) * 2.5)], 1, 0)) %>% "
"0","  ungroup() %>% "
"0","  group_by(Diag,Gender) %>% "
"0","  mutate(bmi = case_when(is.na(bmi) ~ sample(bmi[!is.na(bmi)], 1), T ~ bmi)) %>% "
"0","  ungroup() %>% "
"0","  mutate(BMI = case_when(bmi <  18.5                ~ ""Underweight"","
"0","                         bmi >= 18.5 & bmi < 25     ~ ""Normal"","
"0","                         bmi >= 25 & bmi < 30       ~ ""Overweight"","
"0","                         bmi >= 30                  ~ ""Obese""),"
"0","         BMI = fct_relevel(BMI, ""Normal"",""Underweight"",""Overweight""),"
"0","         Period = ifelse(Period==""2016-2019"",""2016"",Period))"
